name: Run Tests

on:
  pull_request:
    branches: [main]

jobs:
  test:
    name: Swift Tests
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04-arm
            container: swift:6.1.0
          - os: macos-15
            xcode-select: /Applications/Xcode_16.3.app

    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: xcode-select
        if: ${{ matrix.xcode-select != '' }}
        run: |
          sudo xcode-select --switch ${{ matrix.xcode-select }}

      - name: Build
        run: swift build

      - name: Run Tests
        run: swift test --enable-code-coverage

      # Generate code coverage report
      - name: Generate Code Coverage Report
        shell: bash
        run: |
          llvm-cov export -format="lcov" .build/release/*.xctest -instr-profile .build/release/codecov/default.profdata > coverage.lcov
      
      # Install dependencies for Codecov
      - name: Install dependencies
        shell: bash
        run: |
          apt-get update
          apt-get install -y curl gnupg
      
      # Upload coverage to Codecov
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: edgeengineer/edge-agent
          fail_ci_if_error: false
